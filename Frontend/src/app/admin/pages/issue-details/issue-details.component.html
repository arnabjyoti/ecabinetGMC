<div class="main-content container py-4">
  <!-- ISSUE INFORMATION -->
  <div class="ccard sshadow-sm ssection-card">
    <div class="ccard-body">
      <div class="row mb-2">
        <div class="col-md-4"><strong>Issue ID:</strong> {{ issue?.id }}</div>
        <div class="col-md-4"><strong>Ward No:</strong> {{ issue?.ward }}</div>
        <div class="col-md-4">
          <strong>Location:</strong> {{ issue.location }}
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Department:</strong> {{ issue?.department }}
        </div>
        <div class="col-md-4">
          <strong>Raised By:</strong>
          {{
            activeTab == "draft" || activeTab == "sent"
              ? "Myself"
              : issue.raisedByName
          }}
        </div>
        <div class="col-md-4">
          <strong>Submission Date:</strong> {{ issue.branchActionDate }}
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-12">
          <p class="mb-2">
            <strong>Description:</strong> {{ issue.description }}
          </p>
        </div>
      </div>
      <!-- ATTACHMENTS -->
      <div class="ccard sshadow-sm ssection-card" style="min-height: 20vh">
        <div class="ccard-body">
          <h5 class="fw-bold mb-3">
            Attachments
            <button
              *ngIf="issue.status != 'Accepted' && issue.status != 'Rejected'"
              (click)="fileInput.click()"
              class="btn"
              style="
                background-color: rgb(12, 102, 236);
                color: rgb(248, 248, 248);
              "
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              title="Attach File"
            >
              <i class="bi bi-paperclip me-1"></i>
            </button>
            <input
              type="file"
              accept=".jpg,.png,.pdf"
              #fileInput
              hidden
              (change)="onFileSelected($event)"
            />
          </h5>

          <div
            class="row g-4 mb-5"
            *ngIf="issue.attachments?.length; else noAttachments"
          >
            <div class="col-md-3" *ngFor="let a of issue.attachments">
              <div class="attachment-card text-center p-3">
                <i class="bi bi-file-earmark-text attachment-icon"></i>
                <p class="fw-semibold mt-2">{{ a.name }}</p>

                <a
                  [href]="a.src"
                  target="_blank"
                  download
                  class="btn btn-primary btn-sm w-100"
                >
                  <i class="bi bi-download"></i> View
                </a>
              </div>
            </div>
          </div>
          <ng-template #noAttachments>
            <div style="color: rgb(186, 184, 184); font-weight: bold">
              No attachments found
            </div>
          </ng-template>
        </div>
      </div>
      <div *ngIf="activeTab != 'draft'" class="row mb-5">
        <div class="col-md-12">
          <div class="row mb-2">
            <div class="col-md-12">
              <!-- WORKFLOW TIMELINE -->
              <div class="ccard sshadow-sm ssection-card">
                <div class="ccard-body">
                  <h5 class="fw-bold mb-3">Workflow Status Timeline</h5>

                  <div class="timeline-container">
                    <div class="timeline-line"></div>

                    <div *ngFor="let t of issue.timeline" class="timeline-item">
                      <div class="timeline-dot"></div>
                      <div>
                        <p class="timeline-step mb-0">{{ t.step }}</p>
                        <small class="text-muted">{{ t.date }}</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-md-12">
              <h5 class="fw-bold mt-3">
                <strong>Final Acceptance Status:&nbsp;</strong>
                <span
                  class="badge status-badge text-white bg-{{
                    issue.status == 'Pending'
                      ? 'warning'
                      : issue.status == 'Accepted'
                      ? 'success'
                      : 'danger'
                  }}"
                >
                  {{ issue.status }}
                </span>
              </h5>
              <h5
                class="fw-bold mt-3"
                *ngIf="
                  issue?.municipalAction == 'Rejected' ||
                  issue?.commissionerAction == 'Rejected'
                "
              >
                <strong>Rejection Reason:&nbsp;</strong>
                <span
                  class="badge status-badge text-white bg-{{
                    issue.status == 'Pending'
                      ? 'warning'
                      : issue.status == 'Accepted'
                      ? 'success'
                      : 'danger'
                  }}"
                >
                  {{
                    issue?.municipalAction == "Rejected"
                      ? issue?.municipalActionRemarks
                      : issue?.commissionerAction == "Rejected"
                      ? issue?.commissionerActionRemarks
                      : ""
                  }}
                </span>
              </h5>
            </div>
          </div>
        </div>
      </div>
      <!-- <div *ngIf="activeTab != 'draft'" class="row">
        <div class="col-md-12">
          <div class="row mb-2">
            <div class="col-md-4">
              <strong>Forwarded to Municipal Secretary:</strong>
              {{ issue?.branchAction == "Sent" ? "Yes" : "No" }} 
            </div>
            <div class="col-md-1">
              <strong><i class="bi bi-arrow-right"></i></strong>
            </div>
            <div class="col-md-3">
              <strong>Approval Status:</strong> {{ issue?.municipalAction == "Approved" ? "Approved" : issue?.municipalAction == "Rejected" ? "Rejected" : "Pending" }}
            </div>
            <div class="col-md-1">
              <strong><i class="bi bi-arrow-right"></i></strong>
            </div>
            <div class="col-md-3"><strong>Date:</strong> {{ issue?.municipalActionDate ? issue?.municipalActionDate : "NA" }}</div>
          </div>
          <div class="row mb-2">
            <div class="col-md-4">
              <strong>Forwarded to Commissioner:</strong>
              {{ issue?.municipalAction == "Approved" ? "Yes" : "No" }}
            </div>
            <div class="col-md-1">
              <strong><i class="bi bi-arrow-right"></i></strong>
            </div>
            <div class="col-md-3">
              <strong>Approval Status:</strong> {{ issue?.commissionerAction == "Approved" ? "Approved" : issue?.commissionerAction == "Rejected" ? "Rejected" : "Pending" }}
            </div>
            <div class="col-md-1">
              <strong><i class="bi bi-arrow-right"></i></strong>
            </div>
            <div class="col-md-3"><strong>Date:</strong> {{ issue?.commissionerActionDate ? issue?.commissionerActionDate : "NA" }}</div>
          </div>
          <div class="row mb-2">
            <div class="col-md-4">
              <strong>Approved for MIC Meeting:</strong>
              {{ issue?.commissionerAction == "Approved" ? "Yes" : "No" }}
            </div>
             <div class="col-md-1">
              <strong><i class="bi bi-arrow-right"></i></strong>
            </div>
            <div class="col-md-3">
              <strong>Voting Status:</strong> {{ issue?.voting ? issue?.voting : "Pending" }}
            </div>
             <div class="col-md-1">
              <strong><i class="bi bi-arrow-right"></i></strong>
            </div>
            <div class="col-md-3"><strong>Date:</strong> {{ issue?.votingDate ? issue?.votingDate : "NA" }}</div>
          </div>
          <div class="row mb-2">
            <div class="col-md-12">
              <p class="mt-3">
                <strong>Final Acceptance Status:&nbsp;</strong>
                <span
                  class="badge status-badge text-white bg-{{
                    issue.status == 'Pending'
                      ? 'warning'
                      : issue.status == 'Accepted'
                      ? 'success'
                      : 'danger'
                  }}"
                >
                  {{ issue.status }}
                </span>
              </p>
            </div>
          </div>
        </div>
      </div> -->
    </div>
  </div>

  <!-- COMMENTS -->
  <div class="ccard sshadow-sm ssection-card">
    <div
      class="row mb-5"
      *ngIf="
        activeTab != 'draft' &&
        issue.status != 'Accepted' &&
        issue.status != 'Rejected'
      "
    >
      <div class="col-md-12">
        <div class="ccard sshadow-sm ssection-card mb-5"></div>
        <div class="ccard-body">
          <h5 class="fw-bold mb-3"><i class="bi bi-chat me-1"></i> Comments</h5>

          <div>
            <div class="comments-wrapper">
              <div
                class="comment"
                *ngFor="let comment of allComments"
                [ngClass]="{
                  'my-comment': comment.commentBy === user.userId,
                  'other-comment': comment.commentBy !== user.userId
                }"
              >
                <div class="comment-bubble">
                  <div class="comment-header">
                    <span class="comment-author">
                      {{
                        comment.commentBy === user.userId
                          ? "Me"
                          : comment.commentByName
                      }}
                    </span>
                    <span class="comment-date">
                      {{ comment.createdAt | date : "short" }}
                    </span>
                  </div>

                  <div class="comment-content">
                    {{ comment.comment }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="comment-box">
            <!-- <img src="assets/user-avatar.png" class="avatar" alt="User" /> -->

            <div class="input-wrapper">
              <input
                type="text"
                class="comment-input"
                placeholder="Write a comment..."
                [(ngModel)]="commentText"
                (keyup.enter)="sendComment()"
              />

              <button
                class="send-btn"
                [disabled]="!commentText?.trim()"
                (click)="sendComment()"
              >
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" *ngIf="user.role == 'branch_user' && activeTab == 'draft'">
      <div class="col-md-12">
        <button
          class="btn btn-primary px-4"
          (click)="confirmMe('branch_user')"
          style="float: right"
        >
          <i class="bi bi-send"></i> Send
        </button>
      </div>
    </div>
  </div>

  <div
    class="row"
    *ngIf="
      user.role == 'municipal_secretary' &&
      issue.municipalAction != 'Approved' &&
      issue.municipalAction != 'Rejected'
    "
  >
    <div class="col-md-12">
      <button
        class="btn btn-primary px-4"
        (click)="confirmMe('municipal_secretary')"
        style="float: right"
      >
        <i class="bi bi-check-circle"></i> Approve
      </button>
      &nbsp;&nbsp;
      <button
        class="btn btn-primary px-4"
        data-bs-toggle="modal"
        data-bs-target="#issueRejectModal"
        style="float: left"
      >
        <i class="bi bi-x-circle"></i> Reject
      </button>
    </div>
  </div>

  <div
    class="row"
    *ngIf="
      user.role == 'commissioner' &&
      issue.commissionerAction != 'Approved' &&
      issue.commissionerAction != 'Rejected'
    "
  >
    <div class="col-md-12">
      <button
        class="btn btn-primary px-4"
        (click)="confirmMe('commissioner')"
        style="float: right"
      >
        <i class="bi bi-check-circle"></i> Approve
      </button>
      &nbsp;&nbsp;
      <button
        class="btn btn-primary px-4"
        data-bs-toggle="modal"
        data-bs-target="#issueRejectModal"
        style="float: left"
      >
        <i class="bi bi-x-circle"></i> Reject
      </button>
    </div>
  </div>

  <div
    class="row"
    *ngIf="
      user.role == 'commissioner' && issue.commissionerAction == 'Approved'
    "
  >
    <div class="col-md-12">
      <button
        *ngIf="issue.voting == ''"
        class="btn btn-primary px-4"
        (click)="startVoting()"
        style="float: right"
      >
        <i class="bi bi-hand-thumbs-up"></i> Start Voting
      </button>
      <button
        *ngIf="issue.voting == 'Started'"
        class="btn btn-primary px-4"
        disabled
        style="float: right"
      >
        <i class="bi bi-hand-thumbs-up"></i> Voting Started
      </button>
    </div>
  </div>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="issueRejectModal" tabindex="-1">
    <div class="modal-dialog modal-md">
      <div class="modal-content shadow-lg border-0 rounded-3">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title fw-bold">
            <i class="bi bi-x-square"></i>&nbsp;Rejecting Issue
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-12 mt-2">
              <label class="form-label fw-semibold"
                >Rejection reason<span style="color: red">*</span></label
              >
              <textarea
                class="form-control form-control-sm"
                rows="5"
                [(ngModel)]="rejectionReason"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button
            id="issueRejectModalClose"
            class="btn btn-default rounded-pill"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button class="btn btn-primary rounded-pill" (click)="rejectMe()">
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <ngx-spinner
    bdColor="rgba(51,51,51,0.8)"
    size="medium"
    color="#fff"
    type="ball-spin-clockwise"
    style="background-color: aliceblue"
  >
    <p style="color: white">
      <i
        class="fa fa-circle-o-notch fa-spin fa-4x text-danger"
        aria-hidden="true"
      ></i
      >Loading...Please Wait
    </p>
  </ngx-spinner>
</div>
